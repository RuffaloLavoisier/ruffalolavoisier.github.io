<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Frida 탐지 방법에 대한 고찰" /><meta property="og:locale" content="en" /><meta name="description" content="Frida 탐지와 우회 그리고 탐지 우회와 우회 탐지" /><meta property="og:description" content="Frida 탐지와 우회 그리고 탐지 우회와 우회 탐지" /><link rel="canonical" href="https://ruffalolavoisier.github.io/posts/idea_for_detect_frida/" /><meta property="og:url" content="https://ruffalolavoisier.github.io/posts/idea_for_detect_frida/" /><meta property="og:site_name" content="Unforgettable" /><meta property="og:image" content="https://ruffalolavoisier.github.io/assets/img/common/cat_mouse_game.PNG" /><meta property="og:image:alt" content="Cat and Mouse Game" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2025-03-14T03:58:13+09:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://ruffalolavoisier.github.io/assets/img/common/cat_mouse_game.PNG" /><meta name="twitter:image:alt" content="Cat and Mouse Game" /><meta property="twitter:title" content="Frida 탐지 방법에 대한 고찰" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-03-14T03:58:13+09:00","datePublished":"2025-03-14T03:58:13+09:00","description":"Frida 탐지와 우회 그리고 탐지 우회와 우회 탐지","headline":"Frida 탐지 방법에 대한 고찰","image":{"lqip":"data:image/webp;base64","alt":"Cat and Mouse Game","url":"https://ruffalolavoisier.github.io/assets/img/common/cat_mouse_game.PNG","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ruffalolavoisier.github.io/posts/idea_for_detect_frida/"},"url":"https://ruffalolavoisier.github.io/posts/idea_for_detect_frida/"}</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2677268060283942" crossorigin="anonymous"></script><title>Frida 탐지 방법에 대한 고찰 | Unforgettable</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Unforgettable"><meta name="application-name" content="Unforgettable"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js,npm/mermaid@11.4.0/dist/mermaid.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script> <script>mermaid.initialize({startOnLoad:true});</script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="https://ruffalolavoisier.github.io/assets/img/profile.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">Unforgettable</a><p class="site-subtitle fst-italic mb-0">I wonder Why I wonder</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/project/" class="nav-link"> <i class="fa-fw fas fa-laptop-code"></i> <span>PROJECT</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/RuffaloLavoisier" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="javascript:location.href = 'mailto:' + ['RuffaloLavoisier','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="https://stackoverflow.com/users/17522538/ruffalo" aria-label="stack-overflow" target="_blank" rel="noopener noreferrer" > <i class="fab fa-stack-overflow"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>Frida 탐지 방법에 대한 고찰</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip><b>Frida 탐지 방법에 대한 고찰</b></h1><i></i><p class="post-desc fw-light mb-4">Frida 탐지와 우회 그리고 탐지 우회와 우회 탐지</p><div class="post-meta text-muted"> <span> Posted <time data-ts="1741892293" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Mar 14, 2025 </time> </span><div class="mt-3 mb-3"> <a href="https://ruffalolavoisier.github.io/assets/img/common/cat_mouse_game.PNG" class="popup img-link preview-img blur"><img data-src="https://ruffalolavoisier.github.io/assets/img/common/cat_mouse_game.PNG" alt="Cat and Mouse Game" width="1200" height="630" data-lqip="true" src="data:image/webp;base64"></a><figcaption class="text-center pt-2 pb-2">Cat and Mouse Game</figcaption></div><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/RuffaloLavoisier">Ruffalo</a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="3494 words" > <em>19 min</em> read</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">Frida 탐지 방법에 대한 고찰</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">Contents</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">Frida 탐지 방법에 대한 고찰</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"><h2 id="introduction"><span class="me-2">Introduction</span><a href="#introduction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>일반적으로 안드로이드 어플리케이션을 이용하면 앱은 실행 시 라이브러리를 로드하여 실행할 수 있다. 이는 안드로이드에서 정해 놓은 시스템 파티션이나 앱과 함께 제공되는 디렉터리 경로에서만 라이브러리를 가져와 사용할 수 있다는 의미이다.</p><p>아래와 같이 정해진 앱의 소스 디렉터리에서 라이브러리를 로드할 수 있다.</p><div class="language-shell nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>Loading library : /data/app/~~p-vfdsffewfewg<span class="o">==</span>/com.ruffalo.test-dQ8dewfeffewfef8qA<span class="o">==</span>/lib/arm64/libnative-lib.so
</pre></table></code></div></div><p>허가되지 않은 혹은 안드로이드 정책에 반하는 위치에 있는 라이브러리가 <code class="language-plaintext highlighter-rouge">/proc/self/maps</code> 에서 올라오면 해당 디바이스 환경은 비정상 혹은 위협으로 판단하고서 앱의 실행을 거부하거나 중단하여야 한다.</p><p>이와 같은 환경과 행동들은 위협 탐지부터 시작하여 위협 탐지 우회 그리고 위협 우회 탐지라는 끝없는 싸움에 방아쇠가 되었다.</p><p>그러한 기술들 중 하나로 루팅이 있는데 이는 대중이 많이 사용하는 Magisk 개발자가 이야기한 것처럼 hide 라는 기능에 끝없는 패치가 이어졌다고 말한다.</p><blockquote class="prompt-info"><p><strong>MagiskHide Removal</strong>; I have lost interest in fighting this battle for quite a while; plus, the existing MagiskHide implementation is flawed in so many ways. Decoupling Magisk from root hiding is, in my opinion, beneficial to the community. Ever since my announcement on Twitter months ago, highly effective “root hiding” modules (much MUCH better than MagiskHide) has been flourishing, which again shows that people are way more capable than I am on this subject. So why not give those determined their time to shine, and let me focus on improving Magisk instead of drowning in the everlasting cat-and-mouse game 😉.</p></blockquote><p>본 글에서는 여러 소스코드와 안드로이드 zygote 가 올라오고 앱이 눈에 보이기까지 따라가보면서 변화한 메모리를 통해 비정상 환경을 감지하는 최첨단 탐지 메커니즘을 살펴보았다.</p><p>그중 동적 바이너리 분석 도구에 대한 탐지 시점과 탐지 우회 그리고 그것을 한 번 더 우회 탐지하는 기법을 사용했는데 이는 마치 고양이와 쥐의 게임을 연상시키는 부분이 없지 않아 있을 것이다.</p><p>실제 상황을 가정한다면 비정상 환경에서 사용을 막는 앱이 있다고 폈을 때 비정상 단말에서 앱이 실행 상태에 있을 때 앱은 사용을 중단하라고 사용자에게 Alert 를 띄운다.</p><p>그러나 누군가는 그럼에도 사용할 수 있게 이를 우회하려고 한다. 그러나 또 누군가는 이를 우회할 경우를 대비하여 한 단계 더 고도화된 탐지 대책을 세우고 있다.</p><p>이러한 끝도 없는 공방전이 이어지는 것이라고 볼 수 있다.</p><h2 id="understanding-the-core-issue"><span class="me-2">Understanding the Core Issue</span><a href="#understanding-the-core-issue" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>아래는 현재 공개된 몇가지 탐지 아이디어에 대하여 살펴본 케이스이며 실제 소프트웨어에서도 사용되는 방법이다.</p><p>본 글에서는 자체 검파일한 바이너리를 사용하였다.</p><h3 id="메모리를-통한-탐지"><span class="me-2">메모리를 통한 탐지</span><a href="#메모리를-통한-탐지" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>먼저 비정상 환경이 준비된 모바일이나 그러한 앱이 설치된 모바일을 준비한다.</p><p>그 후 모바일에서 탐지 로직이 적용된 어플리케이션을 시작한다.</p><p>이때 앱의 pid 를 살펴보면 아래와 같다.</p><p>현재 pid 는 20109 이다.</p><div class="language-shell nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="o">{</span>
    <span class="s2">"arch"</span>: <span class="s2">"arm64"</span>,
    <span class="s2">"codeSigningPolicy"</span>: <span class="s2">"optional"</span>,
    <span class="s2">"id"</span>: 20109,
    <span class="s2">"pageSize"</span>: 4096,
    <span class="s2">"platform"</span>: <span class="s2">"linux"</span>,
    <span class="s2">"pointerSize"</span>: 8
<span class="o">}</span>
</pre></table></code></div></div><p>로컬 PC 에서 모바일에 리눅스 쉘처럼 붙을 수 있는데 쉘로 먼저 접근한다.</p><div class="language-shell nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>x1q:/proc/20109 <span class="c"># cat maps | grep ruffalo                                                                           </span>
6d22b2c000-6d23555000 r--p 00000000 00:01 265762                         /memfd:ruffalo-agent-64.so <span class="o">(</span>deleted<span class="o">)</span>
6d23556000-6d2428d000 r-xp 00a29000 00:01 265762                         /memfd:ruffalo-agent-64.so <span class="o">(</span>deleted<span class="o">)</span>
6d2428d000-6d2435e000 r--p 0175f000 00:01 265762                         /memfd:ruffalo-agent-64.so <span class="o">(</span>deleted<span class="o">)</span>
6d2435f000-6d2437a000 rw-p 01830000 00:01 265762                         /memfd:ruffalo-agent-64.so <span class="o">(</span>deleted<span class="o">)</span>
x1q:/proc/20109 <span class="c">#</span>
</pre></table></code></div></div><p>위에서 볼 수 있는 것처럼 <code class="language-plaintext highlighter-rouge">/proc/[pid]</code> 에 접근하여 maps 를 살펴보면 현재 메모리에 올라온 Frida 를 살펴볼 수 있다.</p><p>보통 이러한 로직을 작성한다고 하면 아래와 같을 것으로 보인다.</p><p>상황에 따라서 다를 수 있지만 이해를 위하여 간단하게 작성해본다.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="kt">char</span><span class="o">*</span> <span class="n">p_result</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">readline_from_maps</span><span class="p">,</span> <span class="s">"/memfd:ruffalo-agent-64.so"</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">!=</span> <span class="n">p_result</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Detected</span>
  <span class="n">__android_log_print</span><span class="p">(</span><span class="n">ANDROID_LOG_VERBOSE</span><span class="p">,</span> <span class="s">"Sample-Test"</span><span class="p">,</span> <span class="s">"Found"</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>strstr 함수는 아래와 같은 인자를 받고 반환을 한다.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kt">char</span><span class="o">*</span> <span class="n">strstr</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">string1</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">string2</span><span class="p">)</span>
</pre></table></code></div></div><p>string2 문자열이 string1 에 존재한다면 string2 문자열을 반환하며 존재하지 않으면 0 을 반환한다.</p><p>따라서 maps 에서 읽은 문자열에 탐지하려는 문자열이 있는지 확인하는 것이다.</p><h3 id="메모리-탐지-우회"><span class="me-2">메모리 탐지 우회</span><a href="#메모리-탐지-우회" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>이를 우회하는 걸 봐보갰다.</p><p><code class="language-plaintext highlighter-rouge">/proc/[pid]/maps</code> 에 올라온 agent 를 탐지하였는데 이를 우회한다면 다음과 같을 것이다.</p><p>실제라면 로직을 보호하기 위하여 고난도의 난독화와 암호화 그리고 런타임 탐지로 로직을 들여다보기 힘들텐데 현재는 이 과정을 다 우회했다고 가정한다.</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="nx">Interceptor</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span><span class="nx">Module</span><span class="p">.</span><span class="nf">getExportByName</span><span class="p">(</span><span class="dl">'</span><span class="s1">libc.so</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">strstr</span><span class="dl">'</span><span class="p">),</span> <span class="p">{</span>
    <span class="na">onEnter</span><span class="p">:</span> <span class="nf">function </span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">str1</span> <span class="o">=</span> <span class="nx">Memory</span><span class="p">.</span><span class="nf">readCString</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="kd">var</span> <span class="nx">str2</span> <span class="o">=</span> <span class="nx">Memory</span><span class="p">.</span><span class="nf">readCString</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">str2</span><span class="p">.</span><span class="nf">indexOf</span><span class="p">(</span><span class="dl">"</span><span class="s2">/memfd:ruffalo-agent-64.so</span><span class="dl">"</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">){</span>
            <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">str1:%s str2:%s</span><span class="se">\n</span><span class="dl">"</span><span class="p">,</span> <span class="nx">str1</span><span class="p">,</span> <span class="nx">str2</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">hook</span><span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">},</span>        
    <span class="na">onLeave</span><span class="p">:</span> <span class="nf">function </span><span class="p">(</span><span class="nx">retval</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">hook</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">retval</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="mh">0x0</span><span class="p">);</span>
            <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Replace ret value to 0</span><span class="dl">"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">});</span>
</pre></table></code></div></div><p>위와 같이 우회 스크립트를 작성할 수 있는데 strstr 함수 반환값을 조작할 수 있다.</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nx">str2</span><span class="p">.</span><span class="nf">indexOf</span><span class="p">(</span><span class="dl">"</span><span class="s2">string</span><span class="dl">"</span><span class="p">)</span>
</pre></table></code></div></div><p>해당 함수는 <code class="language-plaintext highlighter-rouge">str2</code> 문자열 안에 <code class="language-plaintext highlighter-rouge">string</code> 이 있다면 시작하는 그 문자열의 인덱스 번호를 반환하고 없으면 <code class="language-plaintext highlighter-rouge">-1</code> 을 반환하는 함수이다.</p><p>즉 특정 문자열을 발견하면 strstr 반환값을 0 으로 변조하는 것이다.</p><blockquote class="prompt-info"><p><code class="language-plaintext highlighter-rouge">strstr(str1, str2)</code> 반환값 0 이 의미하는 것은 str1 안에 str2 이 없다는 의미이다.</p></blockquote><h3 id="실행중인-프로세스-탐지를-통한-우회-탐지"><span class="me-2">실행중인 프로세스 탐지를 통한 우회 탐지</span><a href="#실행중인-프로세스-탐지를-통한-우회-탐지" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>앞에서 메모리를 통한 탐지를 진행했는데 특정 문자열일 때 반환값을 변조하여 우회한 것을 볼 수 있다.</p><p>그럼 이번에는 이에 대응하여 프로세스를 통한 탐지를 진행해겠다.</p><div class="language-shell nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>x1q:/proc/20109 <span class="c"># ps -ef | grep ruffalo                                                                                 </span>
root         21513 30531 19 02:29:32 /debug_ramdisk/.magisk/pts/1 00:00:00 <span class="nb">grep </span>ruffalo
root         24938     1 0 01:35:54 ?     00:05:36 ruffalo-server-16.6.3-android-arm64
root         24954     1 0 01:35:56 ?     00:00:00 10 unix:abstract<span class="o">=</span>/ruffalo-b8b5725d-57e7-4c20-b8f7-8e7573912b0d
x1q:/proc/20109 <span class="c">#</span>
</pre></table></code></div></div><p>위 프로세스 탐지도 비슷하게 진행 할 수 있다.</p><p><code class="language-plaintext highlighter-rouge">ps</code> 명령어를 통해 현재 실행중인 프로세스들을 볼 수 있다.</p><p>아래와 같이 구현할 수 있을 것이다.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="kt">char</span><span class="o">*</span> <span class="n">p_result</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">readline_from_process</span><span class="p">,</span> <span class="s">"ruffalo-server-16.6.3-android-arm64"</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">!=</span> <span class="n">p_result</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Detected</span>
  <span class="n">__android_log_print</span><span class="p">(</span><span class="n">ANDROID_LOG_VERBOSE</span><span class="p">,</span> <span class="s">"Sample-Test"</span><span class="p">,</span> <span class="s">"Found"</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>process 를 확인하는 명령어를 통해 해당 문자열을 파싱하고 탐지하려는 문자열이 있는지 확인하는 것이다.</p><p>위는 예시이며 여러 방법이 있겠지만 실제론 오탐을 줄이고 정탐을 높게 구현하는 게 중요하다.</p><h3 id="실행중인-프로세스-탐지-우회"><span class="me-2">실행중인 프로세스 탐지 우회</span><a href="#실행중인-프로세스-탐지-우회" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>process 를 확인하고 이때 실행중인 여부를 확인하는 것인데 이를 우회한다면 다음과 같을 것이다.</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="nx">Interceptor</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span><span class="nx">Module</span><span class="p">.</span><span class="nf">getExportByName</span><span class="p">(</span><span class="dl">'</span><span class="s1">libc.so</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">strstr</span><span class="dl">'</span><span class="p">),</span> <span class="p">{</span>
    <span class="na">onEnter</span><span class="p">:</span> <span class="nf">function </span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">str1</span> <span class="o">=</span> <span class="nx">Memory</span><span class="p">.</span><span class="nf">readCString</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="kd">var</span> <span class="nx">str2</span> <span class="o">=</span> <span class="nx">Memory</span><span class="p">.</span><span class="nf">readCString</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">str2</span><span class="p">.</span><span class="nf">indexOf</span><span class="p">(</span><span class="dl">"</span><span class="s2">ruffalo-server-16.6.3-android-arm64</span><span class="dl">"</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">){</span>
            <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">str1:%s str2:%s</span><span class="se">\n</span><span class="dl">"</span><span class="p">,</span> <span class="nx">str1</span><span class="p">,</span> <span class="nx">str2</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">hook</span><span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">},</span>        
    <span class="na">onLeave</span><span class="p">:</span> <span class="nf">function </span><span class="p">(</span><span class="nx">retval</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">hook</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">retval</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="mh">0x0</span><span class="p">);</span>
            <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Replace ret value to 0</span><span class="dl">"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">});</span>
</pre></table></code></div></div><p>이도 동일하게 특정 문자열인지 확인하고 반환값을 변조하여 우회하는 스크립트이다.</p><h3 id="네트워크-탐지를-통한-우회-탐지"><span class="me-2">네트워크 탐지를 통한 우회 탐지</span><a href="#네트워크-탐지를-통한-우회-탐지" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>그럼 이번에는 네트워크를 통하여 우회 탐지를 진행해보려고 한다.</p><p>netstat 는 어플리케이션이나 디바이스에 네트워크 상태를 보여주는 명령어이다.</p><p>명령어를 통해 아래와 같이 현재 연결된 정보를 볼 수 있다.</p><div class="language-shell nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>x1q:/proc/21522 <span class="c"># netstat | grep ruffalo                                                                                </span>
unix  3      <span class="o">[</span> <span class="o">]</span>         STREAM     CONNECTED     29075456 @/ruffalo-87868e60-a33d-415a-ba9e-2718ebaf230d
unix  2      <span class="o">[</span> <span class="o">]</span>         STREAM     CONNECTED     7130091  @/ruffalo-c99f0fff-fcd1-42ff-a321-4e2546485a58
unix  2      <span class="o">[</span> <span class="o">]</span>         STREAM     CONNECTED     3545381  @/ruffalo-6afc2dde-d4d1-4050-8c17-b91aa1a0afae

                                        <span class="o">{</span> <span class="nb">.</span> <span class="nb">.</span> .<span class="o">}</span>

unix  2      <span class="o">[</span> <span class="o">]</span>         STREAM     CONNECTED     5332037  @/ruffalo-f561ed25-df09-40c5-b0fe-ee037f88f74a
unix  2      <span class="o">[</span> <span class="o">]</span>         STREAM     CONNECTED     7213926  @/ruffalo-c4e008d7-df55-4d85-a5b0-61ffe3f548d4
x1q:/proc/21522 <span class="c"># </span>
</pre></table></code></div></div><p>아래와 같이 동일하게 특정 문자열을 탐지할 수 있다.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="kt">char</span><span class="o">*</span> <span class="n">p_result</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">readline_from_process</span><span class="p">,</span> <span class="s">"ruffalo"</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">!=</span> <span class="n">p_result</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Detected</span>
  <span class="n">__android_log_print</span><span class="p">(</span><span class="n">ANDROID_LOG_VERBOSE</span><span class="p">,</span> <span class="s">"Sample-Test"</span><span class="p">,</span> <span class="s">"Found"</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>netstat 실행을 통해 해당 문자열을 파싱하고 탐지하려는 문자열이 있는지 확인하는 것이다.</p><p>명령어 결과에 따라 구현 로직이 튕길 수 있어서 모든 경우의 수에 다 부합하게 작성하는 게 중요하다.</p><h3 id="네트워크-탐지-우회"><span class="me-2">네트워크 탐지 우회</span><a href="#네트워크-탐지-우회" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>위에서 구현한 netstat 를 확인하고 이때 실행중인 여부를 확인하는 코드를 우회한다면 다음과 같을 것이다.</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="nx">Interceptor</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span><span class="nx">Module</span><span class="p">.</span><span class="nf">getExportByName</span><span class="p">(</span><span class="dl">'</span><span class="s1">libc.so</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">strstr</span><span class="dl">'</span><span class="p">),</span> <span class="p">{</span>
    <span class="na">onEnter</span><span class="p">:</span> <span class="nf">function </span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">str1</span> <span class="o">=</span> <span class="nx">Memory</span><span class="p">.</span><span class="nf">readCString</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="kd">var</span> <span class="nx">str2</span> <span class="o">=</span> <span class="nx">Memory</span><span class="p">.</span><span class="nf">readCString</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">str2</span><span class="p">.</span><span class="nf">indexOf</span><span class="p">(</span><span class="dl">"</span><span class="s2">ruffalo</span><span class="dl">"</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">){</span>
            <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">str1:%s str2:%s</span><span class="se">\n</span><span class="dl">"</span><span class="p">,</span> <span class="nx">str1</span><span class="p">,</span> <span class="nx">str2</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">hook</span><span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">},</span>        
    <span class="na">onLeave</span><span class="p">:</span> <span class="nf">function </span><span class="p">(</span><span class="nx">retval</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">hook</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">retval</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="mh">0x0</span><span class="p">);</span>
            <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Replace ret value to 0</span><span class="dl">"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">});</span>
</pre></table></code></div></div><p>위와 같이 특정 문자열을 찾아서 대입해주면 쉽게 우회가 가능하다.</p><h3 id="포트-스캔-탐지를-통한-우회-탐지"><span class="me-2">포트 스캔 탐지를 통한 우회 탐지</span><a href="#포트-스캔-탐지를-통한-우회-탐지" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>그럼 이번엔 포트 스캔을 통해 우회 탐지를 진행해보겠다.</p><p><code class="language-plaintext highlighter-rouge">netstat</code> 에 <code class="language-plaintext highlighter-rouge">-ntlp</code> 를 사용하면 LISTEN 중인 포트 정보 표시한다.</p><blockquote class="prompt-info"><p>Frida 같은 경우 실행 시 포트를 지정할 수 있어서 손쉽게 포트 변경이 가능하다.</p></blockquote><div class="language-shell nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>x1q:/proc/21522 <span class="c"># netstat -ntlp | grep ruffalo                                                                                       </span>
tcp        0      0 127.0.0.1:27042         0.0.0.0:<span class="k">*</span>               LISTEN      24938/ruffalo-server-16.6.3-android-arm64
tcp6       0      0 <span class="o">[</span>::]:34459              <span class="o">[</span>::]:<span class="k">*</span>                  LISTEN      24938/ruffalo-server-16.6.3-android-arm64
x1q:/proc/21522 <span class="c">#</span>
</pre></table></code></div></div><p>이는 아래의 옵션들이 조합된 것이다.</p><div class="language-shell nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nt">-l</span>	Listening server sockets
<span class="nt">-t</span>	TCP sockets
<span class="nt">-n</span>	Don<span class="s1">'t resolve names
-p	Show PID/program name of sockets
</span></pre></table></code></div></div><p>이를 통해 열려있는 포트를 검사하거나 문자열을 검사할 수 있을 것이다.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">bool</span> <span class="n">result</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">readline_netstat</span><span class="p">,</span> <span class="s">"27042"</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">strstr</span><span class="p">(</span><span class="n">readline_netstat</span><span class="p">,</span> <span class="s">"LISTEN"</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="nb">true</span> <span class="o">==</span> <span class="n">result</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Detected</span>
  <span class="n">__android_log_print</span><span class="p">(</span><span class="n">ANDROID_LOG_VERBOSE</span><span class="p">,</span> <span class="s">"Sample-Test"</span><span class="p">,</span> <span class="s">"Found"</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>위처럼 netstat 결과에서 알 수 있듯이 열려있는 포트 번호와 현재 LISTEN 상태인지 탐지하는 것이다.</p><h3 id="포트-스캔-탐지-우회"><span class="me-2">포트 스캔 탐지 우회</span><a href="#포트-스캔-탐지-우회" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>포트 스캔 방식도 우회한다면 다음과 같을 것이다.</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="nx">Interceptor</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span><span class="nx">Module</span><span class="p">.</span><span class="nf">getExportByName</span><span class="p">(</span><span class="dl">'</span><span class="s1">libc.so</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">strstr</span><span class="dl">'</span><span class="p">),</span> <span class="p">{</span>
    <span class="na">onEnter</span><span class="p">:</span> <span class="nf">function </span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">str1</span> <span class="o">=</span> <span class="nx">Memory</span><span class="p">.</span><span class="nf">readCString</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="kd">var</span> <span class="nx">str2</span> <span class="o">=</span> <span class="nx">Memory</span><span class="p">.</span><span class="nf">readCString</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">str2</span><span class="p">.</span><span class="nf">indexOf</span><span class="p">(</span><span class="dl">"</span><span class="s2">27042</span><span class="dl">"</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>
         <span class="o">||</span> <span class="nx">str2</span><span class="p">.</span><span class="nf">indexOf</span><span class="p">(</span><span class="dl">"</span><span class="s2">LISTEN</span><span class="dl">"</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">){</span>
            <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">str1:%s str2:%s</span><span class="se">\n</span><span class="dl">"</span><span class="p">,</span> <span class="nx">str1</span><span class="p">,</span> <span class="nx">str2</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">hook</span><span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">},</span>        
    <span class="na">onLeave</span><span class="p">:</span> <span class="nf">function </span><span class="p">(</span><span class="nx">retval</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">hook</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">retval</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="mh">0x0</span><span class="p">);</span>
            <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Replace ret value to 0</span><span class="dl">"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">});</span>
</pre></table></code></div></div><p>포트 번호와 LISTEN 문자열일 때 반환값을 변조하여 우회한다.</p><h2 id="conclusion"><span class="me-2">Conclusion</span><a href="#conclusion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>지금까지 Frida 를 탐지할 수 있는 방법들을 살펴보았다. 이외에도 수십가지 방법으로 Frida 를 탐지할 수 있는 방법이 존재한다. 하지만 재밌는 점은 Frida 를 통해 Frida 탐지 기능을 우회할 수 있다는 점이다.</p><p>메모리 동작을 통한 탐지 방법은 깊게 알아봐야 하지만 우회는 탐지 기능을 비웃는 것처럼 아주 손쉽게 후킹을 통해 회피할 수 있다.</p><p>탐지하는 기능이든 우회든 방도를 알아보기 위하여 깊숙하게 알아봐야 하는 건 동일하다.</p><p>위 환경은 사실 일반적인 앱 상테에서 감지해야 하는 것이 조건이므로 좀 더 아이디어를 내야 할 부분이 많을 것이다. 적용할 수 없는 아이디어가 훨씬 많을 것이며 사용할 수 없는 방법들도 많을 것이다.</p><p>이와 비슷하게 루팅 기술 또한 비슷한 스토리를 가지고 있다. 루팅은 shamiko 라는 모듈을 통해 추가적으로 zygisk 흔적을 지우는데 사용된다.</p><p>수차례 보안개발자들이 탐지 방법을 찾아내면서 Magisk 쪽에서도 몇번 패치를 하는데 이또한 길고 긴 공방전으로 이어지곤 했다.</p><p>탐지 방법을 가졌다하더라도 2차, 3차적으로 대책을 세워야 할 것으로 보인다.</p><p>단순하게 코드를 작성하면 탐지 로직이 훤히 읽혀 금방 우회가 가능하다.</p><p>난독화나 암호화 또는 시스템 호출을 피하거나 저수준 레벨의 언어를 사용한다면 우회를 위한 분석 또한 쉽지 않을 것이다.</p><p>그래서 금융앱이나 핀테크 앱은 깊은 곳에 보안기술이 꽁꽁 숨겨져있어 공격자들은 이를 파헤쳐 우회할 수 있는 로직을 찾아내기도 한다.</p><p>그렇게되면 우회는 이전과 다르게 때론 오프셋으로 접근해야 할 수 있고 탐지 로직을 무력화하기 위하여 기존 탐지 문자열들과 상반되는 의미없는 문자열이나 숫자 또는 랜덤하게 부여된 문자열이 있는 바이너리를 사용할 수 있다.</p><p>이외에도 많은 도구와 환경들이 있는데 이러한 것들은 실행 시 안드로이드 깊숙한 메모리 어딘가에 흔적을 남기며 이를 코드로 로직화하면 정상적으로 탐지할 수 있다.</p><p>그러나 최근 코드 trace 기능이 강화되어 앱 시작 전 dynamic hook 을 준비하여 모든 코드 호출부를 추적할 수 있다.</p><p>따라서 아무리 완벽한 탐지 시그니처와 수단을 가졌다하더라도 마침내 로직은 쉽게 우회될 것이다.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/research/">research</a>, <a href="/categories/android/">android</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/android/" class="post-tag no-text-decoration" >android</a> <a href="/tags/research/" class="post-tag no-text-decoration" >research</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author. <br>If you find any errors, please let me know by comment or email. Thank you.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Frida%20%ED%83%90%EC%A7%80%20%EB%B0%A9%EB%B2%95%EC%97%90%20%EB%8C%80%ED%95%9C%20%EA%B3%A0%EC%B0%B0%20-%20Unforgettable&url=https%3A%2F%2Fruffalolavoisier.github.io%2Fposts%2Fidea_for_detect_frida%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fa-brands fa-square-x-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Frida%20%ED%83%90%EC%A7%80%20%EB%B0%A9%EB%B2%95%EC%97%90%20%EB%8C%80%ED%95%9C%20%EA%B3%A0%EC%B0%B0%20-%20Unforgettable&u=https%3A%2F%2Fruffalolavoisier.github.io%2Fposts%2Fidea_for_detect_frida%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fruffalolavoisier.github.io%2Fposts%2Fidea_for_detect_frida%2F&text=Frida%20%ED%83%90%EC%A7%80%20%EB%B0%A9%EB%B2%95%EC%97%90%20%EB%8C%80%ED%95%9C%20%EA%B3%A0%EC%B0%B0%20-%20Unforgettable" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/idea_for_detect_frida/">Frida 탐지 방법에 대한 고찰</a><li class="text-truncate lh-lg"> <a href="/posts/2023-memory/">2023년 회고</a><li class="text-truncate lh-lg"> <a href="/posts/malware_analysis_a/">동적으로 로드되는 실행 파일에 대한 고찰 - 1</a><li class="text-truncate lh-lg"> <a href="/posts/about_file_api/">안드로이드 앱 실행 시 어떤 파일들에 접근할까</a><li class="text-truncate lh-lg"> <a href="/posts/android_api_level/">Android API level</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/research/">research</a> <a class="post-tag btn btn-outline-primary" href="/tags/android/">android</a> <a class="post-tag btn btn-outline-primary" href="/tags/develop/">develop</a> <a class="post-tag btn btn-outline-primary" href="/tags/git/">git</a> <a class="post-tag btn btn-outline-primary" href="/tags/blog/">blog</a> <a class="post-tag btn btn-outline-primary" href="/tags/linux/">linux</a> <a class="post-tag btn btn-outline-primary" href="/tags/mobile/">mobile</a> <a class="post-tag btn btn-outline-primary" href="/tags/software-developer/">Software Developer</a> <a class="post-tag btn btn-outline-primary" href="/tags/diary/">diary</a> <a class="post-tag btn btn-outline-primary" href="/tags/osw/">osw</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/about_file_api/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1741610146" data-df="ll" > Mar 10, 2025 </time><h4 class="pt-0 my-2"><b>안드로이드 앱 실행 시 어떤 파일들에 접근할까</b></h4><div class="text-muted"><p>How to access file on Android</p></div></div></a></article><article class="col"> <a href="/posts/access_app_directory/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1741094224" data-df="ll" > Mar 4, 2025 </time><h4 class="pt-0 my-2"><b>Android 앱 내부 디렉토리에 대한 고찰</b></h4><div class="text-muted"><p>Android Internal Directory 에 대한 심층 분석</p></div></div></a></article><article class="col"> <a href="/posts/where_is_image_url_data_on_device/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1739822588" data-df="ll" > Feb 18, 2025 </time><h4 class="pt-0 my-2"><b>Android Application Research Series 3</b></h4><div class="text-muted"><p>디바이스 어딘가에 저장되는 데이터에 대한 DB 파일 암호화 따라가기</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/malware_analysis_a/" class="btn btn-outline-primary" aria-label="Older" ><p><b>동적으로 로드되는 실행 파일에 대한 고찰 - 1</b></p></a><div class="btn btn-outline-primary disabled" aria-label="Newer"><p>-</p></div></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://github.com/RuffaloLavoisier">Ruffalo</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p><div class='typing'>I'm <STRONG><span class="text"></span></STRONG></div><script> document.addEventListener("DOMContentLoaded", function () { const $text = document.querySelector(".typing .text"); const letters = [ "Developer", "Author", "Creator", "Inventor", "Conductor", "Traveler" ]; const speed = 100; let i = 0; const typing = async () => { const letter = letters[i].split(""); while (letter.length) { await wait(speed); $text.innerHTML += letter.shift(); } await wait(800); remove(); }; const remove = async () => { const letter = letters[i].split(""); while (letter.length) { await wait(speed); letter.pop(); $text.innerHTML = letter.join(""); } i = !letters[i + 1] ? 0 : i + 1; typing(); }; function wait(ms) { return new Promise(res => setTimeout(res, ms)) } setTimeout(typing, 1500); }); </script></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.2.4" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/research/">research</a> <a class="post-tag btn btn-outline-primary" href="/tags/android/">android</a> <a class="post-tag btn btn-outline-primary" href="/tags/develop/">develop</a> <a class="post-tag btn btn-outline-primary" href="/tags/git/">git</a> <a class="post-tag btn btn-outline-primary" href="/tags/blog/">blog</a> <a class="post-tag btn btn-outline-primary" href="/tags/linux/">linux</a> <a class="post-tag btn btn-outline-primary" href="/tags/mobile/">mobile</a> <a class="post-tag btn btn-outline-primary" href="/tags/software-developer/">Software Developer</a> <a class="post-tag btn btn-outline-primary" href="/tags/diary/">diary</a> <a class="post-tag btn btn-outline-primary" href="/tags/osw/">osw</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><script> (function () { const origin = 'https://utteranc.es'; const themeMapper = Theme.getThemeMapper('github-light', 'github-dark'); const initTheme = themeMapper[Theme.visualState]; let script = document.createElement('script'); script.src = 'https://utteranc.es/client.js'; script.setAttribute('repo', 'RuffaloLavoisier/ruffalolavoisier.github.io'); script.setAttribute('issue-term', 'pathname'); script.setAttribute('theme', initTheme); script.crossOrigin = 'anonymous'; script.async = true; const $footer = document.querySelector('footer'); $footer.insertAdjacentElement('beforebegin', script); addEventListener('message', (event) => { let newTheme;if (event.source === window && event.data && event.data.id === Theme.ID) { newTheme = themeMapper[Theme.visualState]; const message = { type: 'set-theme', theme: newTheme }; const utterances = document.querySelector('.utterances-frame').contentWindow; utterances.postMessage(message, origin); } }); })(); </script> <script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
